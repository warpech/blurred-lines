<!DOCTYPE html>
<html>

<head>
    <title>Blurred lines</title>
</head>

<body>
    <table>
        <tr>
            <td>A1</td>
            <td>B1</td>
            <td>C1</td>
            <td>D1</td>
        </tr>
        <tr>
            <td>A2</td>
            <td id="cell1">B2</td>
            <td class="padded">
                <div>C2</div>
            </td>
            <td class="padded" id="cell2">
                <div>D2</div>
            </td>
        </tr>
    </table>


    <svg xmlns="http://www.w3.org/2000/svg">
    </svg>

    <style>
        body {
            font-family: sans-serif;
        }

        table {
            border-spacing: 0;
            margin: 0 0 20px 0;
            border-width: 0;
            table-layout: fixed;
            width: 0;
        }

        td {
            border-style: solid;
            border-color: #ccc;
            border-top-width: 0;
            border-left-width: 0;
            border-right-width: 1px;
            border-bottom-width: 1px;
            height: 3ch;
            width: 5ch;
            empty-cells: show;
            padding: 0 0.2ch 0 0.2ch;
            background-color: #fff;
        }

        td.padded {
            padding: 1px;
        }

        td.padded div {
            background: #bbb;
            display: flex;
            height: 100%;
            align-items: center;
        }

        td:first-child {
            border-left-width: 1px;
        }

        tr:first-child td {
            border-top-width: 1px;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
        }

        path {
            fill: none;
        }

        label {
            display: flex;
            font-size: 11px;
            align-items: center;
            height: 30px;
        }

        label span {
            display: block;
            width: 140px;
        }

        label input {
            display: block;
            width: 100px;
        }
    </style>

    <label><span>Number of edges</span><input id="edgesRange" type="range" min=0 max=3 value=3><output></output></label>
    <label><span>Line width</span><input id="widthRange" type="range" min=0 max=100 value=100><output></output></label>
    <label><span>Half pixel correction method</span><input id="halfPixelRange" type="range" min=0 max=2
            value=2><output></output></label>
    <label><span>Shape rendering</span><input id="shapeRendering" type="range" min=0 max=2
            value=2><output></output></label>
    <label><span>Line chaining</span><input id="lineChaining" type="range" min=0 max=1 value=0><output></output></label>
    <label><span>Device pixel ratio</span><output id="devicePixelRatio"></output></label>
    <div id="controls"></div>

    <div>
        <button id="reset-preset">Reset</button>
        <button id="handsontable-preset">Handsontable</button>
    </div>

    <script>
        var svg = document.querySelector('svg');
        var cell1 = document.querySelector('#cell1');
        var cell2 = document.querySelector('#cell2');
        var controls = document.querySelector('#controls');
        var state = {};

        function updateState(elem, name, callb, output) {
            var index = parseInt(elem.value, 10);
            console.log('index', index, callb(index));
            state[name] = callb(index);
            output.innerHTML = state[name];
            render();
        }

        function addControl(name, labelText, range, callb) {
            var output = document.createElement('output');

            var input = document.createElement('input');
            input.setAttribute('id', name);
            input.setAttribute('type', 'range');
            input.setAttribute('min', '0');
            input.setAttribute('max', '' + (range - 1));
            input.addEventListener('input', function (ev) { updateState(ev.target, name, callb, output) });
            input.addEventListener('change', function (ev) { updateState(ev.target, name, callb, output) }); // IE9

            var span = document.createElement('span');
            span.innerHTML = labelText;

            var label = document.createElement('label');
            label.appendChild(span);
            label.appendChild(input);
            label.appendChild(output);

            controls.appendChild(label);
        }

        var pixelGridAlignmentOptions = ['no', 'yes'];
        addControl('pixelGridAlignment', "Align to pixel grid", 2, (index) => {
            return pixelGridAlignmentOptions[index];
        });

        var presetDefault = {
            pixelGridAlignment: pixelGridAlignmentOptions.indexOf('yes')
        }

        var presetHandsontable = {
            pixelGridAlignment: pixelGridAlignmentOptions.indexOf('no')
        }

        function applyPreset(preset) {
            var keys = Object.keys(preset);
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var elem = document.getElementById(key);
                elem.value = preset[key];
                elem.dispatchEvent(new Event("change"));
            }
        }

        applyPreset(presetDefault);

        var edges;
        var multiplier;
        var halfPixelCorrection;
        var shapeRendering;
        var lineChaining;

        var dpr = window.devicePixelRatio;
        document.querySelector('#devicePixelRatio').innerHTML = dpr;

        setInterval(function () {
            if (dpr !== window.devicePixelRatio) {
                dpr = window.devicePixelRatio;
                document.querySelector('#devicePixelRatio').innerHTML = dpr;
            }
        }, 250);


        function processEdgesRange(elem) {
            edges = parseInt(elem.value, 10) + 1;
            render();
            elem.nextElementSibling.innerHTML = edges;
        }

        function processWidthRange(elem) {
            multiplier = parseInt(elem.value, 10) / 100;
            render();
            elem.nextElementSibling.innerHTML = multiplier;
        }

        function processHalfPixelRange(elem) {
            switch (elem.value) {
                case '2':
                    halfPixelCorrection = 'handsontable' // one direction at a time
                    break;
                case '1':
                    halfPixelCorrection = 'simple' // all directions
                    break;
                case '0':
                    halfPixelCorrection = 'none'
                    break;
            }
            render();
            elem.nextElementSibling.innerHTML = halfPixelCorrection;
        }

        function processShapeRenderingRange(elem) {
            switch (elem.value) {
                case '2':
                    shapeRendering = 'crispEdges' // one direction at a time
                    break;
                case '1':
                    shapeRendering = 'geometricPrecision' // all directions
                    break;
                case '0':
                    shapeRendering = 'auto'
                    break;
            }
            render();
            elem.nextElementSibling.innerHTML = shapeRendering;
        }

        function processLineChainingRange(elem) {
            switch (elem.value) {
                case '1':
                    lineChaining = true;
                    break;
                case '0':
                    lineChaining = false;
                    break;
            }
            render();
            elem.nextElementSibling.innerHTML = lineChaining;
        }

        function processAlignPixelGrid(elem) {
            switch (elem.value) {
                case '1':
                    alignPixelGrid = true;
                    break;
                case '0':
                    alignPixelGrid = false;
                    break;
            }
            render();
            elem.nextElementSibling.innerHTML = alignPixelGrid;
        }

        function registerRange(elem, callb) {
            elem.addEventListener('input', function (ev) { callb(ev.target) });
            elem.addEventListener('change', function (ev) { callb(ev.target) }); // IE9
            callb(elem);
        }

        registerRange(document.querySelector('#edgesRange'), processEdgesRange);
        registerRange(document.querySelector('#widthRange'), processWidthRange);
        registerRange(document.querySelector('#halfPixelRange'), processHalfPixelRange);
        registerRange(document.querySelector('#shapeRendering'), processShapeRenderingRange);
        registerRange(document.querySelector('#lineChaining'), processLineChainingRange);

        var width = 500;
        var height = 80;
        svg.style.width = width + 'px';
        svg.style.height = height + 'px';
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        svg.setAttribute('viewBox', '0 0 ' + width + ' ' + height);

        function drawPathAroundElement(elem, width) {
            var rect = elem.getBoundingClientRect()
            var path = svg.ownerDocument.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('stroke', 'blue');
            path.setAttribute('stroke-width', width * multiplier);
            path.setAttribute('stroke-dasharray', 4);
            path.setAttribute('shape-rendering', shapeRendering);

            var x1 = rect.left;
            var y1 = rect.top;
            var x2 = x1 + rect.width - (width - 1);
            var y2 = y1 + rect.height - (width - 1);

            var lines = [
                [x1, y1, x2, y1],
                [x2, y1, x2, y2],
                [x2, y2, x1, y2],
                [x1, y2, x1, y1],
            ];

            lines.splice(edges);

            if (state.pixelGridAlignment === 'yes') {
                lines = alignToPixelGrid(lines);
            }

            if (halfPixelCorrection === 'pixelgrid') {
                lines = pixelgridHalfPixelCorrection(lines, width);
            }
            else if (halfPixelCorrection === 'handsontable') {
                lines = handsontableHalfPixelCorrection(lines, width);
            }
            else if (halfPixelCorrection === 'simple') {
                lines = simpleHalfPixelCorrection(lines, width);
            }

            var command = '';
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                if (lineChaining) {
                    if (i === 0) {
                        command = 'M ' + line[0] + ' ' + line[1] + ' L ' + line[2] + ' ' + line[3] + ' ';
                    }
                    else {
                        command += 'L ' + line[2] + ' ' + line[3] + ' ';
                    }
                }
                else {
                    command += 'M ' + line[0] + ' ' + line[1] + ' L ' + line[2] + ' ' + line[3] + ' ';
                }

            }

            path.setAttribute('d', command);

            svg.appendChild(path);
        }

        function render() {
            empty(this.svg);
            drawPathAroundElement(cell1, 1);
            drawPathAroundElement(cell2, 2);
        }
        render();

        function alignToPixelGrid(lines) {
            var newLines = new Array(lines.length);

            function calc(num) {
                return Math.round(num * devicePixelRatio) / devicePixelRatio;
            }

            for (var ii = 0; ii < lines.length; ii++) {
                var x1 = calc(lines[ii][0]);
                var y1 = calc(lines[ii][1]);
                var x2 = calc(lines[ii][2]);
                var y2 = calc(lines[ii][3]);

                newLines[ii] = [x1, y1, x2, y2];
            }

            return newLines;
        }

        function handsontableHalfPixelCorrection(lines, width) {
            var newLines = new Array(lines.length);
            var needSubPixelCorrection = (width % 2 !== 0); // disable antialiasing

            for (var ii = 0; ii < lines.length; ii++) {
                var x1 = lines[ii][0];
                var y1 = lines[ii][1];
                var x2 = lines[ii][2];
                var y2 = lines[ii][3];

                if (needSubPixelCorrection) {
                    var isHorizontal = y1 === y2;

                    if (isHorizontal) {
                        y1 -= 0.5;
                        y2 -= 0.5;
                    } else {
                        x1 -= 0.5;
                        x2 -= 0.5;
                    }
                }

                newLines[ii] = [x1, y1, x2, y2];
            }

            return newLines;
        }

        function simpleHalfPixelCorrection(lines, width) {
            var newLines = new Array(lines.length);
            var needSubPixelCorrection = (width % 2 !== 0); // disable antialiasing

            for (var ii = 0; ii < lines.length; ii++) {
                var x1 = lines[ii][0];
                var y1 = lines[ii][1];
                var x2 = lines[ii][2];
                var y2 = lines[ii][3];

                if (needSubPixelCorrection) {
                    x1 -= 0.5;
                    x2 -= 0.5;
                    y1 -= 0.5;
                    y2 -= 0.5;
                }

                newLines[ii] = [x1, y1, x2, y2];
            }

            return newLines;
        }

        function empty(element) {
            var child;
            while (child = element.lastChild) {
                element.removeChild(child);
            }
        }

        document.querySelector('#reset-preset').addEventListener('click', function () {
            document.querySelector('#edgesRange').setAttribute('value', '3');
            document.querySelector('#widthRange').setAttribute('value', '100');
            document.querySelector('#halfPixelRange').setAttribute('value', '2');
            document.querySelector('#shapeRendering').setAttribute('value', '2');
            document.querySelector('#lineChaining').setAttribute('value', '0');
            applyInputChanges();
            applyPreset(presetDefault);
        });

        document.querySelector('#handsontable-preset').addEventListener('click', function () {
            document.querySelector('#edgesRange').setAttribute('value', '3');
            document.querySelector('#widthRange').setAttribute('value', '100');
            document.querySelector('#halfPixelRange').setAttribute('value', '2');
            document.querySelector('#shapeRendering').setAttribute('value', '1');
            document.querySelector('#lineChaining').setAttribute('value', '1');
            applyInputChanges();
            applyPreset(presetHandsontable);
        });

        function applyInputChanges() {
            applyInputChange(document.querySelector('#edgesRange'));
            applyInputChange(document.querySelector('#widthRange'));
            applyInputChange(document.querySelector('#halfPixelRange'));
            applyInputChange(document.querySelector('#shapeRendering'));
            applyInputChange(document.querySelector('#lineChaining'));
        };

        function applyInputChange(elem) {
            if ("createEvent" in document) {
                var evt = document.createEvent("HTMLEvents");
                evt.initEvent("change", false, true);
                elem.dispatchEvent(evt);
            }
            else
                elem.fireEvent("onchange");
        }
    </script>
</body>

</html>